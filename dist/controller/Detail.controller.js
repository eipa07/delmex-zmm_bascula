sap.ui.define(["delmex/zmmbascula/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/m/PDFViewer","delmex/zmmbascula/util/formatter"],(e,t,a,o,r,s,i)=>{"use strict";return e.extend("delmex.zmmbascula.controller.Detail",{formatter:i,onInit(){var e=this.getRouter();e.getRoute("RouteDetail").attachMatched(this._onObjectMatched,this);this._pdfViewer=new s({title:"Vista previa del PDF"});this.getView().addDependent(this._pdfViewer);var t=new sap.ui.model.json.JSONModel;let a=this.get_JSON_PDF();t.setData(a);this.getView().setModel(t,"pdfStructureModel");let o=this.detailSettingsModel();this.getView().setModel(o,"settingsModel")},_onObjectMatched(e){var a=e.getParameter("arguments");var o=a.folio;var s=this;var i=this.getView().getModel("zbasc");var n="/Folio('"+o+"')";i.read(n,{success:function(e,a){let o=new t;o.setData(e);s.getView().setModel(o,"basculaDetails")},error:function(e){r.error(e)}})},goBackBtn(){this.goBack()},onShowPDF:function(){var e=new jsPDF;var t=this.getView().getModel("pdfStructureModel").getData().Structure;var a=this.getView().getModel("basculaDetails").getData();const o=e.internal.pageSize.getWidth();const r=90;const s=30;const i=(o-r)/2;const n=10;var c=10;var l=12;e.setFontSize(c);const d=e.getTextWidth(t.Header.Line1);const m=(o-d)/2;const x=e.getTextWidth(t.Header.Line2);const g=(o-x)/2;const u=e.getTextWidth(t.Header.Line3);const h=(o-u)/2;const p=e.getTextWidth(t.Header.Line4);const v=(o-p)/2;const f=e.getTextWidth(t.Header.Line5);const L=(o-f)/2;const b=e.getTextWidth(t.Header.Line6);const w=(o-b)/2;const H=e.getTextWidth(t.Header.Line7);const D=(o-H)/2;var _=t.Body.Folio+a.Folio;const B=sap.ui.require.toUrl("delmex/zmmbascula/images/Logo.png");this.loadImageAsBase64(B,function(c){e.addImage(c,"PNG",i,20,r,s);e.setTextColor(7,31,99);e.setFont("helvetica","bolditalic");e.text(t.Header.Line1,m,70);e.text(t.Header.Line2,g,75);e.text(t.Header.Line3,h,80);e.text(t.Header.Line4,v,85);e.text(t.Header.Line5,L,90);e.text(t.Header.Line6,w,95);e.text(t.Header.Line7,D,100);e.setFontSize(l);e.text(_,o-(n+40),115,{align:"right"});const d=20;var x=t.Body.Placa;var u=t.Body.Bruto;var p=t.Body.Bound;var f=t.Body.Fecha_Hora_SALIDA_1;var b=t.Body.Bruto;var H=t.Body.Called_Neto;var B=t.Body.Fecha_Hora_SALIDA_2;a.Pesaje=this.formatter.formatNumberWithCommas(a.Pesaje.trim());a.Pesaje2=this.formatter.formatNumberWithCommas(a.Pesaje2.trim());a.PesoNeto=this.formatter.formatNumberWithCommas(a.PesoNeto.trim());e.setFont("helvetica","italic");e.text(x,d,140);e.text(a.Placa,d+30,140);e.text(t.Helpers.Line,d+30,141);e.text(u,d,150);e.text(p,d,155);e.text(a.Pesaje.trim(),d+30,155);e.text(t.Helpers.Line,d+30,156);var F=this.formatter.formatDate(a.FechaEntBas);e.text(f,d,165);e.text(B,d,170);e.text(F,60,170);e.text(t.Helpers.Line,d+40,171);e.text(x,d,185);e.text(a.Placa.trim(),d+30,185);e.text(t.Helpers.Line,d+30,186);e.text(b,d,200);e.text(a.Pesaje2.trim(),d+30,200);e.text(t.Helpers.Line,d+30,201);e.text(H,d,215);e.text(a.PesoNeto.trim(),d+40,215);e.text(t.Helpers.Line,d+40,216);e.text(f,d,225);e.text(B,d,230);e.text(F,60,230);e.text(t.Helpers.Line,d+40,231);var M=t.Footer.Nombre;var P=t.Footer.Referencia_Material;var S=t.Footer.No_Doc;e.text(M,d,250);e.text(a.Conductor,60,250);e.text(t.Helpers.Line,d+40,251);e.text(x,d,260);e.text(a.Placa.trim(),60,260);e.text(t.Helpers.Line,d+40,261);e.text(P.trim(),d,270);e.text(a.Material.trim(),90,270);e.text(t.Helpers.Line,90,271);e.text(S.trim(),d,280);e.text(a.NumeroDoc.trim(),d+50,280);e.text(t.Helpers.Line,d+50,281);const N=e.output("blob");const V=URL.createObjectURL(N);this._pdfViewer.setSource(V);this._pdfViewer.open()}.bind(this))},loadImageAsBase64:function(e,t){var a=new Image;a.onload=function(){var e=document.createElement("canvas");e.width=a.width;e.height=a.height;var o=e.getContext("2d");o.drawImage(a,0,0);var r=e.toDataURL("image/png");t(r)};a.src=e},onUpdateData:async function(){const e=this.getView().getModel("zbasc");const t=this.getView().getModel("basculaDetails");const a=t?.getData()?.Folio;const o=this.getView().byId("txt_NumeroDoc").getValue();if(!a||!o){sap.m.MessageBox.warning(this.getResourceBundle().getText("message.folio_oc_requeridos"));return}const r=`/Alta('${a}')`;const s=e.sServiceUrl+r;const i={NumeroDoc:o};try{let t="/e4a25f08-7b50-4795-a093-b83466778bb4.delmexbasculazmmbascula.delmexzmmbascula-0.0.1/sap/opu/odata/sap/ZUI_BASCULA_SRV_V2/Folio('0')";const a=await this._fetchCsrfToken(t);await $.ajax({url:s,method:"PATCH",headers:{"X-CSRF-Token":a,"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify({NumeroDoc:o}),success:()=>{sap.m.MessageToast.show(this.getResourceBundle().getText("message.actualizacion_exitosa"));e.refresh(true)},error:(e,t)=>{let a=e.responseJSON.error.message.value;console.log("_mensaje: ",a);sap.m.MessageBox.error(a)}})}catch(e){console.error("‚ùå Error obteniendo CSRF Token:",e)}}})});
//# sourceMappingURL=Detail.controller.js.map