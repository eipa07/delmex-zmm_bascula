sap.ui.define(["delmex/zmmbascula/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/m/PDFViewer","delmex/zmmbascula/util/formatter"],(e,t,a,o,r,s,i)=>{"use strict";return e.extend("delmex.zmmbascula.controller.Detail",{formatter:i,onInit(){var e=this.getRouter();e.getRoute("RouteDetail").attachMatched(this._onObjectMatched,this);this._pdfViewer=new s({title:"Vista previa del PDF"});this.getView().addDependent(this._pdfViewer);var t=new sap.ui.model.json.JSONModel;t.loadData("./model/PDF_Structure.json",false);this.getView().setModel(t,"pdfStructureModel");let a=this.detailSettingsModel();this.getView().setModel(a,"settingsModel")},_onObjectMatched(e){var a=e.getParameter("arguments");var o=a.folio;var s=this;var i=this.getView().getModel("zbasc");var n="/Folio('"+o+"')";i.read(n,{success:function(e,a){let o=new t;o.setData(e);s.getView().setModel(o,"basculaDetails")},error:function(e){r.error(e)}})},goBackBtn(){this.goBack()},onShowPDF:function(){const{jsPDF:e}=window.jspdf;const t=new e;var a=this.getView().getModel("pdfStructureModel").getData().Structure;var o=this.getView().getModel("basculaDetails").getData();const r=t.internal.pageSize.getWidth();const s=90;const i=30;const n=(r-s)/2;const c=10;var l=10;var d=12;t.setFontSize(l);const x=t.getTextWidth(a.Header.Line1);const g=(r-x)/2;const u=t.getTextWidth(a.Header.Line2);const m=(r-u)/2;const h=t.getTextWidth(a.Header.Line3);const p=(r-h)/2;const v=t.getTextWidth(a.Header.Line4);const L=(r-v)/2;const f=t.getTextWidth(a.Header.Line5);const w=(r-f)/2;const H=t.getTextWidth(a.Header.Line6);const B=(r-H)/2;const b=t.getTextWidth(a.Header.Line7);const D=(r-b)/2;var _=a.Body.Folio+o.Folio;const F=sap.ui.require.toUrl("delmex/zmmbascula/images/Logo.png");this.loadImageAsBase64(F,function(e){t.addImage(e,"PNG",n,20,s,i);t.setTextColor(7,31,99);t.setFont("helvetica","bolditalic");t.text(a.Header.Line1,g,70);t.text(a.Header.Line2,m,75);t.text(a.Header.Line3,p,80);t.text(a.Header.Line4,L,85);t.text(a.Header.Line5,w,90);t.text(a.Header.Line6,B,95);t.text(a.Header.Line7,D,100);t.setFontSize(d);t.text(_,r-(c+40),115,{align:"right"});const l=20;var x=a.Body.Placa;var u=a.Body.Bruto;var h=a.Body.Bound;var v=a.Body.Fecha_Hora_SALIDA_1;var f=a.Body.Bruto;var H=a.Body.Called_Neto;var b=a.Body.Fecha_Hora_SALIDA_2;t.setFont("helvetica","italic");t.text(x,l,140);t.text(o.Placa,l+30,140);t.text(a.Helpers.Line,l+30,141);t.text(u,l,150);t.text(h,l,155);t.text(o.Pesaje.trim(),l+30,155);t.text(a.Helpers.Line,l+30,156);var F=this.formatter.formatDate(o.FechaEntBas);t.text(v,l,165);t.text(b,l,170);t.text(F,60,170);t.text(a.Helpers.Line,l+40,171);t.text(x,l,185);t.text(o.Placa.trim(),l+30,185);t.text(a.Helpers.Line,l+30,186);t.text(f,l,200);t.text(o.Pesaje2.trim(),l+30,200);t.text(a.Helpers.Line,l+30,201);t.text(H,l,215);t.text(o.PesoNeto.trim(),l+40,215);t.text(a.Helpers.Line,l+40,216);t.text(v,l,225);t.text(b,l,230);t.text(F,60,230);t.text(a.Helpers.Line,l+40,231);var M=a.Footer.Nombre;var S=a.Footer.Referencia_Material;var T=a.Footer.No_Doc;t.text(M,l,250);t.text(o.Conductor,60,250);t.text(a.Helpers.Line,l+40,251);t.text(x,l,260);t.text(o.Folio.trim(),60,260);t.text(a.Helpers.Line,l+40,261);t.text(S.trim(),l,270);t.text(o.Material.trim(),90,270);t.text(a.Helpers.Line,90,271);t.text(T.trim(),l,280);t.text(o.NumeroDoc.trim(),l+50,280);t.text(a.Helpers.Line,l+50,281);const V=t.output("blob");const P=URL.createObjectURL(V);this._pdfViewer.setSource(P);this._pdfViewer.open()}.bind(this))},loadImageAsBase64:function(e,t){var a=new Image;a.onload=function(){var e=document.createElement("canvas");e.width=a.width;e.height=a.height;var o=e.getContext("2d");o.drawImage(a,0,0);var r=e.toDataURL("image/png");t(r)};a.src=e},onUpdateData:async function(){const e=this.getView().getModel("zbasc");const t=this.getView().getModel("basculaDetails");const a=t?.getData()?.Folio;const o=this.getView().byId("txt_NumeroDoc").getValue();if(!a||!o){sap.m.MessageBox.warning(this.getResourceBundle().getText("message.folio_oc_requeridos"));return}const r=`/Alta('${a}')`;const s=e.sServiceUrl+r;const i={NumeroDoc:o};try{let t="/e4a25f08-7b50-4795-a093-b83466778bb4.delmexbasculazmmbascula.delmexzmmbascula-0.0.1/sap/opu/odata/sap/ZUI_BASCULA_SRV_V2/Folio('0')";const a=await this._fetchCsrfToken(t);await $.ajax({url:s,method:"PATCH",headers:{"X-CSRF-Token":a,"Content-Type":"application/json",Accept:"application/json"},data:JSON.stringify({NumeroDoc:o}),success:()=>{sap.m.MessageToast.show(this.getResourceBundle().getText("message.actualizacion_exitosa"));e.refresh(true)},error:e=>{console.error("❌ Error en PATCH:",e);sap.m.MessageBox.error(this.getResourceBundle().getText("message.error_patch"))}})}catch(e){console.error("❌ Error obteniendo CSRF Token:",e);sap.m.MessageBox.error(this.getResourceBundle().getText("message.error_csrf"))}}})});
//# sourceMappingURL=Detail.controller.js.map